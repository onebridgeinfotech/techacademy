#!/bin/bash

# TechAcademy Deployment Script
# Generated by Ansible

set -e

APP_DIR="{{ app_dir }}"
APP_USER="{{ app_user }}"
APP_NAME="{{ app_name }}"
ENVIRONMENT="{{ environment }}"

echo "Starting deployment for {{ app_name }} in {{ environment }} environment..."

# Change to application directory
cd $APP_DIR

# Pull latest code
echo "Pulling latest code..."
git fetch origin
git reset --hard origin/{{ git_branch | default('main') }}

# Install dependencies
echo "Installing dependencies..."
npm ci --production

# Build the application
echo "Building application..."
npm run build

# Run database migrations (if any)
if [ -f "migrations/migrate.js" ]; then
    echo "Running database migrations..."
    node migrations/migrate.js
fi

# Restart the application
echo "Restarting application..."
pm2 restart $APP_NAME-api --env $ENVIRONMENT

# Wait for application to be ready
echo "Waiting for application to be ready..."
sleep 10

# Health check
echo "Performing health check..."
if curl -f http://localhost:3000/health > /dev/null 2>&1; then
    echo "✅ Deployment successful! Application is healthy."
    exit 0
else
    echo "❌ Deployment failed! Application health check failed."
    exit 1
fi




